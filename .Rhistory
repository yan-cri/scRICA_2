#' ## ------------------------------------------------------------------------------------ ##
makeGMMptPlots <- function(pseudoRes, plotFnamePrefix = 'TEST') {
gmmPlotTheme       <- theme(plot.title = element_text(size = 16, hjust = 0.5),
axis.title = element_text(size = 20),
axis.text = element_text(size = 25),
legend.position="right",
legend.text = element_text(size = 20) )
## ---
R1  <- plotPseudotime(pseudoRes = pseudoRes, xCol = 'slingPseudotime_1', xLabel = 'slingshot pseudotime', yCol = 'PCApc1', yLabel = 'PC1', colCol = 'GMM')
# R1  <- R1 + ggtitle(paste(sprintf('PCA: %s', clusterName))) + theme(plot.title = element_text(hjust=0.5))
R1  <- R1 + gmmPlotTheme + NoLegend()
## -
R2  <- plotPseudotime(pseudoRes = pseudoRes, xCol = 'slingPseudotime_1', xLabel = 'slingshot pseudotime', yCol = 'dmPc1', yLabel = 'DC1', colCol = 'GMM')
R2  <- R2 + gmmPlotTheme + NoLegend()
## -
# df_pseudotime           <- as.data.frame(as.data.frame(colData(pseudoRes$sceObj))[, c("ptPC1", "dmapDptRank", "slingPseudotime_1")]) ##consistent with tutorial exploration with rank result for PCA and DM
# colnames(df_pseudotime) <- c("PCA", "Diffusion", "Slingshot")
# pdf(file = sprintf('%s_pseudotime_correlation.pdf', plotname), width = 6, height = 6.5)
# corrplot.mixed(cor(df_pseudotime, use = "na.or.complete"),
#                order = "hclust", tl.col = "black",
#                # main = "Correlation matrix for pseudotime results",
#                mar = c(0, 0, 2, 3))
# dev.off()
## -
p <- plot_grid(R1, R2, align = 'h', ncol = 2, nrow = 1, rel_widths = c(1,1))
save_plot(sprintf('ptGMM_%s_plots.pdf', plotFnamePrefix), p, base_height = 5, base_width = 10)
## ---
}
makeGMMptPlots(pseudoRes = res2, plotFnamePrefix = 'test2')
getwd()
document()
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
newAnnotationRscriptName = NULL
is.null(newAnnotationRscriptName)
expCondSepName = NULL
is.null(expCondSepName)
resDir <- paste(getwd(), 'test', sep = '/')
paste(sprintf('%s/expCond_%s', resDir, 'org' ))
library(devtools)
document()
document()
document()
setwd('..')
install('scRICA/')
?scale_color_tableau
scale_color_tableau(1)
scale_color_tableau(palette = "Tableau 10")
library(ggthemes)
scale_color_tableau(palette = "Tableau 10")
pdf(file = sprintf('ptGMM_%s_lineage.pdf', plotname), width = 4.5, height = 5.5)
plot(df2plot, col = selectedcol[pseudoRes$sceObj$GMM][pseudoRes$sceObj$GMM], pch=16, asp = 1)
lines(SlingshotDataSet(pseudoRes$slingshotRes), lwd=2, type = 'lineages', col = 'black')
dev.off()
??SlingshotDataSet
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
document()
document()
document()
document()
document()
document()
document()
document()
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('..')
getwd()
setwd('scRIC_development/scRICA/')
document()
document()
setwd('..')
install('scRICA')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA')
document()
document()
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA')
document()
document()
document()
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd()
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
ptGmmClusterResNames  <- c()
ptGmmClusterResNames  <- c(ptGmmClusterResNames, 1)
ptGmmClusterResNames
ptGmmClusterResNames  <- c(ptGmmClusterResNames, 4)
ptGmmClusterResNames
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
}
a <- list()
m <- list('m1'=1, 'm2'=4)
a <- m
names(a) <- 'mMessage'
a
a[[1]] <- m
a
a = list()
a[[1]] = m
a
str(a)
names(a) <- c('mMessage')
a$mMessage
b = list()
b[[1]] = a
names(b) <- c('addingA')
b
length(b$addingA)
b$addingA$mMessage
library(devtools)
document()
document()
setwd('..')
install('scRICA')
library(devtools)
document()
document()
setwd('..')
install('scRICA')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
document()
document()
setwd('..')
install('scRICA/')
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
setwd('scRICA/')
document()
document()
setwd('..')
install('scRICA/')
cellcluster <- 'P/V'
cellclusterName              <- cellcluster
gsub('/','', cellclusterName)
gsub('/','_', cellclusterName)
gsub('/','', cellclusterName)
cellclusterName              <- 'P/V-NK'
gsub('/|-','', cellclusterName)
cellclusterName              <- 'P/V-NK.C'
gsub('/|-|[.]','', cellclusterName)
library(devtools)
document()
document()
setwd('..')
install('scRICA')
## This script is used to conduct pseudotime analysis
rm(list = ls())
## ---
suppressPackageStartupMessages(library(scRICA))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(SingleCellExperiment))
currentDir          <- getwd() ##getwd()  = '/Users/yanli/Desktop/757_scRNA-seq/scRICA_results/scRICA_batch34_33693391_integration'
## ---------------------------------------------------------------------------------------
FTintegrateResDir     <- paste(getwd(), 'batch34_3369_3391_integration_rm3295A_fallopian_results/analysis_results_integration_results', sep = '/')
paste(sprintf('%s/ptGmmResAnnoShotI.Rdata', FTintegrateResDir))
currentDir <- '/Users/yanli/Desktop/757_scRNA-seq/scRICA_results/scRICA_batch34_33693391_integration'
## ---------------------------------------------------------------------------------------
FTintegrateResDir     <- paste(getwd(), 'batch34_3369_3391_integration_rm3295A_fallopian_results/analysis_results_integration_results', sep = '/')
paste(sprintf('%s/ptGmmResAnnoShotI.Rdata', FTintegrateResDir))
setwd('/Users/yanli/Desktop/757_scRNA-seq/scRICA_results/scRICA_batch34_33693391_integration')
## ---------------------------------------------------------------------------------------
FTintegrateResDir     <- paste(getwd(), 'batch34_3369_3391_integration_rm3295A_fallopian_results/analysis_results_integration_results', sep = '/')
paste(sprintf('%s/ptGmmResAnnoShotI.Rdata', FTintegrateResDir))
load('/Users/yanli/Desktop/757_scRNA-seq/scRICA_results/scRICA_batch34_33693391_integration/batch34_3369_3391_integration_rm3295A_fallopian_results/analysis_results_integration_results/results_wNewAnnotation_pseudoTime/expCond_tissueSep_newAnno_abbrevName/expCondLevel_A_cluster_SM_fnPseudoTimeRes.Rdata')
ls()
slingshotPtOrder  <- order(sceObj$slingPseudotime_1, na.last = NA)
length(slingshotPtOrder)
head(slingshotPtOrder)
heatdata          <- as.matrix(assays(sceObj)$logcounts[rankGene[1:100], slingshotPtOrder])
library(SingleCellExperiment)
heatdata          <- as.matrix(assays(sceObj)$logcounts[rankGene[1:100], slingshotPtOrder])
ls()
rankGene     <- rownames(sceObjfitGamATres[order(sceObjfitGamATres$pvalue), ])
heatdata          <- as.matrix(assays(sceObj)$logcounts[rankGene[1:100], slingshotPtOrder])
head(heatdata)
head(heatdata[,1:3])
dim(heatdata)
length(slingshotPtOrder)
head(slingshotPtOrder)
head(sceObj$GMM)
table(sceObj$GMM)
heatclus          <- sceObj$GMM[slingshotPtOrder]
table(sceObj$GMM)
table(sceObj$GMM)
head(sceObj$GMM)
head(heatclus)
RColorBrewer::brewer.pal(length(levels(factor(heatclus))),"Set1")[heatclus]
RColorBrewer::brewer.pal(length(levels(factor(heatclus))),"Set1")
length(levels(factor(heatclus)))
## color options
palettes         <- ggthemes::ggthemes_data[["tableau"]][["color-palettes"]][["regular"]]
selectedcol      <- palettes$`Tableau 10`%>% pull(value)
library(dplyr)
selectedcol
palettes         <- ggthemes::ggthemes_data[["tableau"]][["color-palettes"]][["regular"]]
selectedcol      <- palettes$`Tableau 10`%>% pull(value)
selectedcol
levels(factor(heatclus))
selectedcol[length(levels(factor(heatclus))),"Set1"]
selectedcol[length(levels(factor(heatclus)))]
selectedcol[1:length(levels(factor(heatclus)))]
heatmap.2(as.matrix(heatdata), Rowv=T, Colv=F, distfun=dist,
scale="row", hclustfun =hclust, dendrogram="row",
# srtCol = 45, adjCol=c(1, 0.6),
cexCol=0.1, labCol = NULL,
# col=colorpanel(100, "#191970", "#FFF68F", "#EE7621"),
key.title= NA, key.xlab = 'scaled log counts',
key=TRUE, symkey=FALSE, keysize = 1,
key.par = list(cex.lab=1, cex.axis = 1),
density.info="none", trace="none", cexRow=1,
# margins= marginsVals,
ColSideColors= selectedcol[1:length(levels(factor(heatclus)))][heatclus],
# ColSideColors= RColorBrewer::brewer.pal(length(levels(factor(heatclus))),"Set1")[heatclus]
# ,lhei = heatmaplheiVals, lwid = heatmaplwidVals
)
library(gplots)
heatmap.2(as.matrix(heatdata), Rowv=T, Colv=F, distfun=dist,
scale="row", hclustfun =hclust, dendrogram="row",
# srtCol = 45, adjCol=c(1, 0.6),
cexCol=0.1, labCol = NULL,
# col=colorpanel(100, "#191970", "#FFF68F", "#EE7621"),
key.title= NA, key.xlab = 'scaled log counts',
key=TRUE, symkey=FALSE, keysize = 1,
key.par = list(cex.lab=1, cex.axis = 1),
density.info="none", trace="none", cexRow=1,
# margins= marginsVals,
ColSideColors= selectedcol[1:length(levels(factor(heatclus)))][heatclus],
# ColSideColors= RColorBrewer::brewer.pal(length(levels(factor(heatclus))),"Set1")[heatclus]
# ,lhei = heatmaplheiVals, lwid = heatmaplwidVals
)
library(devtools)
getwd()
document()
setwd('.')
setwd('..')
getwd()
install('scRICA')
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
library(devtools)
document()
setwd('..')
install('scRICA/')
resDir <- '/Users/yanli/Desktop/757_scRNA-seq/scRICA_results/scRICA_batch34_33693391_integration/batch34_3369_3391_integration_rm3295A_fallopian_results/analysis_results_integration_results'
rdsFname                <- paste(resDir, "RDS_Dir/analysis_results_integration_results.rds", sep = '/' )
# print(sprintf('85858 rdsFname is %s', rdsFname))
if (!file.exists(rdsFname)) stop("Please execute getClusterMarker() to conduct integration analysis before running getClusterSummaryReplot().")
seuratObjFinal          <<- readRDS(file = as.character(rdsFname))
str(seuratObjFinal$expCond)
factor(seuratObjFinal$expCond)
factor(levels(seuratObjFinal$expCond))
levels(factor(seuratObjFinal$expCond))
newAnnotationRscriptName <- ''
resDir
newAnnotationRscriptName <- '/Users/yanli/Desktop/757_scRNA-seq/scRICA_results/scRICA_batch34_33693391_integration/newAnnotationDefine_falllopian_rm3295A_unsupervisedClusetersAbbrevName.R'
## Assign cell type identity to clusters
## redefine the level of Idents on the y-axis can be adjusted here by inputting order for cell annotation
source(as.character(newAnnotationRscriptName))
expCondName2change = '3041|3043|3061|3203|3295|3296|3369|3391'
seuratObjFinal@meta.data$expCond <- gsub(pattern = as.character(expCondName2change), replacement = '', x = seuratObjFinal@meta.data$expCond)
levels(factor(seuratObjFinal$expCond))
seuratObjFinal$expCond <- factanal(seuratObjFinal$expCond, levels = c('I', 'A', 'F'))
seuratObjFinal$expCond <- factor(seuratObjFinal$expCond, levels = c('I', 'A', 'F'))
levels(factor(seuratObjFinal$expCond))
DimPlot(seuratObjFinal, reduction = "umap", cols = selectedCol, label = T, label.size = 4, repel = T, split.by = 'expCond') + labs(title = 'UMAP clustering', x = "UMAP 1", y = 'UMAP 2')
## -
# selectedCol  <- DiscretePalette(n = length(levels(Idents(seuratObjFinal))), palette = 'alphabet')
selectedCol        <- ggplotColours(n=length(levels(Idents(seuratObjFinal))))
## color options
ggplotColours <- function(n = 6, h = c(0, 360) + 15){
if ((diff(h) %% 360) < 1) h[2] <- h[2] - 360/n
hcl(h = (seq(h[1], h[2], length = n)), c = 100, l = 65)
}
## -
# selectedCol  <- DiscretePalette(n = length(levels(Idents(seuratObjFinal))), palette = 'alphabet')
selectedCol        <- ggplotColours(n=length(levels(Idents(seuratObjFinal))))
DimPlot(seuratObjFinal, reduction = "umap", cols = selectedCol, label = T, label.size = 4, repel = T, split.by = 'expCond') + labs(title = 'UMAP clustering', x = "UMAP 1", y = 'UMAP 2')
library(ggplot2)
DimPlot(seuratObjFinal, reduction = "umap", cols = selectedCol, label = T, label.size = 4, repel = T, split.by = 'expCond') + labs(title = 'UMAP clustering', x = "UMAP 1", y = 'UMAP 2')
## 1. output cell no. for each identified cluster, and exp conditions within each cluster
clusterCellNo                  <- as.data.frame(table(Idents(seuratObjFinal)))
seuratObjFinal$clusterExpCond  <- paste(Idents(seuratObjFinal), seuratObjFinal$expCond, sep = '_')
clusterCellExpNo               <- as.data.frame(table(seuratObjFinal@meta.data$clusterExpCond))
clusterCellExpNo$cluster       <- sapply(strsplit(as.character(clusterCellExpNo$Var1), split = '_'), '[[', 1)
# clusterCellExpNo$exp           <- sapply(strsplit(as.character(clusterCellExpNo$Var1), split = '-'), '[[', 2)
clusterCellExpNo$exp           <- sapply(strsplit(as.character(clusterCellExpNo$Var1), split = '_'), tail, 1)
# library(reshape2)
# library(xlsx)
clusterCellExpNoWide           <- reshape2::dcast(data = clusterCellExpNo, cluster ~ exp, value.var = 'Freq')
clusterCellExpNoWide[is.na(clusterCellExpNoWide)] <- 0
clusterCellExpNoWidePer        <- clusterCellExpNoWide
clusterCellExpNoWideColSum     <- colSums(clusterCellExpNoWidePer %>% dplyr::select(-cluster))
library(dplyr)
clusterCellExpNoWideColSum     <- colSums(clusterCellExpNoWidePer %>% dplyr::select(-cluster))
dim(clusterCellExpNoWidePer)
head(@param )
head(clusterCellExpNoWidePer)
for (i in 2:dim(clusterCellExpNoWidePer)[2]) {
clusterCellExpNoWidePer[,i]      <- round(clusterCellExpNoWidePer[,i]*100/clusterCellExpNoWideColSum[i-1], digits = 2)
}
clusterCellNoComb1             <- merge(clusterCellNo, clusterCellExpNoWide, by.x = 'Var1', by.y = 'cluster' )
clusterCellNoComb              <- merge(clusterCellNoComb1, clusterCellExpNoWidePer, by.x = 'Var1', by.y = 'cluster' )
colnames(clusterCellNoComb)    <- c('clusters', 'cellNo', paste('cellNo', colnames(clusterCellNoComb)[-c(1,2)], sep = '_'))
colnames(clusterCellNoComb)    <- gsub(pattern = '.x', replacement = '', x = colnames(clusterCellNoComb))
colnames(clusterCellNoComb)    <- gsub(pattern = '.y', replacement = '_Per', x = colnames(clusterCellNoComb))
# print(head(clusterCellExpNoWidePer))
# print(dim(clusterCellExpNoWidePer))
perData2plotLong               <- reshape2::melt(clusterCellExpNoWidePer, id.vars = c('cluster'))
perData2plotLong$cluster     <- factor(perData2plotLong$cluster, levels = perClusterOrder )
dim(clusterCellExpNoWidePer)
head(clusterCellExpNoWidePer)
dim(clusterCellExpNoWidePer)[1]
10 < 10
10 > 10
(dim(clusterCellExpNoWidePer)[1] > 10 & dim(clusterCellExpNoWidePer)[1] < 20 )
dim(clusterCellExpNoWidePer)[1]
0.5*16
0.5*18
0.8*20
0.8*16
0.7*16
16 < 17
17 < 17
17>16
0.5*17
0.7*16
# print(head(clusterCellExpNoWidePer))
# print(dim(clusterCellExpNoWidePer))
perData2plotLong               <- reshape2::melt(clusterCellExpNoWidePer, id.vars = c('cluster'))
head(perData2plotLong)
perData2plotLong
clusterCellExpNoWidePer
g1 <- ggplot2::ggplot(perData2plotLong, ggplot2::aes(x = value, y = factor(variable), fill = factor(cluster) )) + ggplot2::geom_bar(stat="identity")
g1 <- g1 + ggplot2::scale_fill_manual(values=selectedCol2)
g1
head(perData2plotLong)
head(perData2plotLong)
expCondNameReorder
expCondNameReorder <- c('I', 'A', 'F')
expCondNameReorder
perData2plotLong$variable    <- factor(perData2plotLong$variable, levels = expCondNameReorder )
g1 <- ggplot2::ggplot(perData2plotLong, ggplot2::aes(x = value, y = factor(variable), fill = factor(cluster) )) + ggplot2::geom_bar(stat="identity")
g1 <- g1 + ggplot2::scale_fill_manual(values=selectedCol2)
g1 <- g1 + ggplot2::labs(title='', x = '', y = '')
g1
rev(expCondNameReorder)
perData2plotLong$variable    <- factor(perData2plotLong$variable, levels = rev(expCondNameReorder) )
g1 <- ggplot2::ggplot(perData2plotLong, ggplot2::aes(x = value, y = factor(variable), fill = factor(cluster) )) + ggplot2::geom_bar(stat="identity")
g1 <- g1 + ggplot2::scale_fill_manual(values=selectedCol2)
g1
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
library(devtools)
document()
document()
setwd('..')
install('scRICA/')
